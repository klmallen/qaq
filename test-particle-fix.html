<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç²’å­å‘å°„ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
        }
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
        }
        button {
            margin: 5px;
            padding: 8px 12px;
            background: #333;
            color: #fff;
            border: 1px solid #666;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div id="info">
        <h3>ğŸ§ª ç²’å­å‘å°„ä¿®å¤æµ‹è¯•</h3>
        <p>æµ‹è¯•ä¿®å¤åçš„ç²’å­å‘å°„ç³»ç»Ÿ</p>
        <div id="status">åˆå§‹åŒ–ä¸­...</div>
    </div>
    
    <div id="controls">
        <h4>æµ‹è¯•æ§åˆ¶</h4>
        <button onclick="testFireEffect()">ğŸ”¥ ç«ç„°æ•ˆæœ</button>
        <button onclick="testSwordTrail()">âš”ï¸ åˆ€å…‰æ•ˆæœ</button>
        <button onclick="testExplosion()">ğŸ’¥ çˆ†ç‚¸æ•ˆæœ</button>
        <button onclick="testIceEffect()">â„ï¸ å†°éœœæ•ˆæœ</button>
        <button onclick="testMagicEffect()">âœ¨ é­”æ³•æ•ˆæœ</button>
        <button onclick="diagnoseAll()">ğŸ” è¯Šæ–­æ‰€æœ‰</button>
        <button onclick="resetAll()">ğŸ”„ é‡ç½®æ‰€æœ‰</button>
    </div>

    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.158.0/build/three.module.js'
        
        // æ¨¡æ‹ŸGPUParticles3Dç±»çš„ç®€åŒ–ç‰ˆæœ¬ç”¨äºæµ‹è¯•
        class TestParticleSystem {
            constructor() {
                this.scene = new THREE.Scene()
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000)
                this.renderer = new THREE.WebGLRenderer()
                this.particles = []
                
                this.init()
            }
            
            init() {
                // è®¾ç½®æ¸²æŸ“å™¨
                this.renderer.setSize(window.innerWidth, window.innerHeight)
                this.renderer.setClearColor(0x000011)
                document.body.appendChild(this.renderer.domElement)
                
                // è®¾ç½®ç›¸æœº
                this.camera.position.set(0, 2, 8)
                this.camera.lookAt(0, 0, 0)
                
                // æ·»åŠ åŸºç¡€å…‰ç…§
                const ambientLight = new THREE.AmbientLight(0x404040, 0.4)
                this.scene.add(ambientLight)
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8)
                directionalLight.position.set(1, 1, 1)
                this.scene.add(directionalLight)
                
                // åˆ›å»ºæµ‹è¯•ç²’å­ç³»ç»Ÿ
                this.createTestParticles()
                
                // å¼€å§‹æ¸²æŸ“å¾ªç¯
                this.startRenderLoop()
                
                document.getElementById('status').textContent = 'âœ… åˆå§‹åŒ–å®Œæˆ'
            }
            
            createTestParticles() {
                // åˆ›å»ºå¤šä¸ªæµ‹è¯•ç”¨çš„ç²’å­ç³»ç»Ÿ
                const positions = [
                    { x: -4, y: 0, z: 0, name: 'ç«ç„°', color: 0xff4444 },
                    { x: -2, y: 0, z: 0, name: 'åˆ€å…‰', color: 0x88aaff },
                    { x: 0, y: 0, z: 0, name: 'çˆ†ç‚¸', color: 0xff8844 },
                    { x: 2, y: 0, z: 0, name: 'å†°éœœ', color: 0x44aaff },
                    { x: 4, y: 0, z: 0, name: 'é­”æ³•', color: 0xaa44ff }
                ]
                
                positions.forEach((pos, index) => {
                    const geometry = new THREE.BufferGeometry()
                    const material = new THREE.PointsMaterial({
                        size: 0.1,
                        color: pos.color,
                        transparent: true,
                        opacity: 0.8,
                        blending: THREE.AdditiveBlending,
                        depthWrite: false,
                        sizeAttenuation: true
                    })
                    
                    // åˆ›å»ºç²’å­ä½ç½®æ•°ç»„
                    const particleCount = 50
                    const positions3 = new Float32Array(particleCount * 3)
                    const colors = new Float32Array(particleCount * 3)
                    
                    // åˆå§‹åŒ–ç²’å­ä½ç½®
                    for (let i = 0; i < particleCount; i++) {
                        positions3[i * 3] = pos.x + (Math.random() - 0.5) * 0.2
                        positions3[i * 3 + 1] = pos.y + Math.random() * 2
                        positions3[i * 3 + 2] = pos.z + (Math.random() - 0.5) * 0.2
                        
                        const color = new THREE.Color(pos.color)
                        colors[i * 3] = color.r
                        colors[i * 3 + 1] = color.g
                        colors[i * 3 + 2] = color.b
                    }
                    
                    geometry.setAttribute('position', new THREE.BufferAttribute(positions3, 3))
                    geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3))
                    
                    const points = new THREE.Points(geometry, material)
                    this.scene.add(points)
                    
                    this.particles.push({
                        points,
                        geometry,
                        material,
                        name: pos.name,
                        basePosition: pos,
                        velocities: [],
                        ages: [],
                        lifetimes: []
                    })
                    
                    // åˆå§‹åŒ–ç²’å­æ•°æ®
                    for (let i = 0; i < particleCount; i++) {
                        this.particles[index].velocities.push(new THREE.Vector3(
                            (Math.random() - 0.5) * 0.02,
                            Math.random() * 0.05 + 0.01,
                            (Math.random() - 0.5) * 0.02
                        ))
                        this.particles[index].ages.push(Math.random() * 3)
                        this.particles[index].lifetimes.push(3 + Math.random() * 2)
                    }
                })
            }
            
            startRenderLoop() {
                let lastTime = performance.now()
                
                const animate = () => {
                    const currentTime = performance.now()
                    const deltaTime = (currentTime - lastTime) / 1000
                    lastTime = currentTime
                    
                    // æ›´æ–°ç²’å­
                    this.updateParticles(deltaTime)
                    
                    // æ¸²æŸ“åœºæ™¯
                    this.renderer.render(this.scene, this.camera)
                    
                    requestAnimationFrame(animate)
                }
                
                animate()
            }
            
            updateParticles(deltaTime) {
                this.particles.forEach((particleSystem, systemIndex) => {
                    const positions = particleSystem.geometry.attributes.position.array
                    const colors = particleSystem.geometry.attributes.color.array
                    const particleCount = positions.length / 3
                    
                    for (let i = 0; i < particleCount; i++) {
                        // æ›´æ–°å¹´é¾„
                        particleSystem.ages[i] += deltaTime
                        
                        // æ£€æŸ¥ç”Ÿå‘½å‘¨æœŸ
                        if (particleSystem.ages[i] >= particleSystem.lifetimes[i]) {
                            // é‡ç”Ÿç²’å­
                            particleSystem.ages[i] = 0
                            positions[i * 3] = particleSystem.basePosition.x + (Math.random() - 0.5) * 0.2
                            positions[i * 3 + 1] = particleSystem.basePosition.y
                            positions[i * 3 + 2] = particleSystem.basePosition.z + (Math.random() - 0.5) * 0.2
                            
                            // é‡æ–°è®¾ç½®é€Ÿåº¦
                            particleSystem.velocities[i].set(
                                (Math.random() - 0.5) * 0.02,
                                Math.random() * 0.05 + 0.01,
                                (Math.random() - 0.5) * 0.02
                            )
                        } else {
                            // æ›´æ–°ä½ç½®
                            positions[i * 3] += particleSystem.velocities[i].x
                            positions[i * 3 + 1] += particleSystem.velocities[i].y
                            positions[i * 3 + 2] += particleSystem.velocities[i].z
                            
                            // åº”ç”¨é‡åŠ›
                            particleSystem.velocities[i].y -= 0.001
                        }
                        
                        // æ›´æ–°é¢œè‰²ï¼ˆæ·¡å‡ºæ•ˆæœï¼‰
                        const ageRatio = particleSystem.ages[i] / particleSystem.lifetimes[i]
                        const alpha = 1.0 - ageRatio
                        const baseColor = new THREE.Color(particleSystem.basePosition.color)
                        
                        colors[i * 3] = baseColor.r * alpha
                        colors[i * 3 + 1] = baseColor.g * alpha
                        colors[i * 3 + 2] = baseColor.b * alpha
                    }
                    
                    // æ ‡è®°éœ€è¦æ›´æ–°
                    particleSystem.geometry.attributes.position.needsUpdate = true
                    particleSystem.geometry.attributes.color.needsUpdate = true
                })
            }
        }
        
        // å…¨å±€æµ‹è¯•ç³»ç»Ÿ
        let testSystem = null
        
        // åˆå§‹åŒ–æµ‹è¯•
        window.addEventListener('load', () => {
            testSystem = new TestParticleSystem()
        })
        
        // æµ‹è¯•å‡½æ•°
        window.testFireEffect = () => {
            console.log('ğŸ”¥ æµ‹è¯•ç«ç„°æ•ˆæœ')
            document.getElementById('status').textContent = 'ğŸ”¥ ç«ç„°æ•ˆæœæµ‹è¯•'
        }
        
        window.testSwordTrail = () => {
            console.log('âš”ï¸ æµ‹è¯•åˆ€å…‰æ•ˆæœ')
            document.getElementById('status').textContent = 'âš”ï¸ åˆ€å…‰æ•ˆæœæµ‹è¯•'
        }
        
        window.testExplosion = () => {
            console.log('ğŸ’¥ æµ‹è¯•çˆ†ç‚¸æ•ˆæœ')
            document.getElementById('status').textContent = 'ğŸ’¥ çˆ†ç‚¸æ•ˆæœæµ‹è¯•'
        }
        
        window.testIceEffect = () => {
            console.log('â„ï¸ æµ‹è¯•å†°éœœæ•ˆæœ')
            document.getElementById('status').textContent = 'â„ï¸ å†°éœœæ•ˆæœæµ‹è¯•'
        }
        
        window.testMagicEffect = () => {
            console.log('âœ¨ æµ‹è¯•é­”æ³•æ•ˆæœ')
            document.getElementById('status').textContent = 'âœ¨ é­”æ³•æ•ˆæœæµ‹è¯•'
        }
        
        window.diagnoseAll = () => {
            console.log('ğŸ” è¯Šæ–­æ‰€æœ‰ç²’å­ç³»ç»Ÿ')
            if (testSystem) {
                testSystem.particles.forEach((p, i) => {
                    console.log(`ç²’å­ç³»ç»Ÿ ${i + 1} (${p.name}):`, {
                        ç²’å­æ•°é‡: p.geometry.attributes.position.count,
                        æè´¨ç±»å‹: p.material.type,
                        åŸºç¡€ä½ç½®: p.basePosition
                    })
                })
            }
            document.getElementById('status').textContent = 'ğŸ” è¯Šæ–­å®Œæˆï¼ŒæŸ¥çœ‹æ§åˆ¶å°'
        }
        
        window.resetAll = () => {
            console.log('ğŸ”„ é‡ç½®æ‰€æœ‰ç²’å­ç³»ç»Ÿ')
            document.getElementById('status').textContent = 'ğŸ”„ é‡ç½®å®Œæˆ'
        }
    </script>
</body>
</html>
